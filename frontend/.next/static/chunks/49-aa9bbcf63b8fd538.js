"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[49],{1077:(e,a,t)=>{t.d(a,{$c:()=>c,DW:()=>u,JO:()=>i,SX:()=>l,W6:()=>n,WF:()=>r,hp:()=>s,m0:()=>d});var o=t(9354);async function n(e){try{let{data:a,error:t}=await o.N.from("raw_events").select("\n        id,\n        event_type,\n        payload_json,\n        received_at,\n        platforms(name)\n      ").gte("received_at","".concat(e,"-01-01")).lt("received_at","".concat(e+1,"-01-01")).order("received_at",{ascending:!1});if(t)return console.error("Erro ao buscar eventos:",t),Array.from({length:12},(e,a)=>({month:a+1,revenue:0}));let n=Array.from({length:12},(e,a)=>({month:a+1,revenue:0}));return null==a||a.forEach(e=>{try{let t=e.payload_json,o=new Date(e.received_at).getMonth()+1,r=0;if("order.paid"===e.event_type||"order.completed"===e.event_type){var a;let o=(null==(a=e.platforms)?void 0:a.name)||null;"Kiwify"===o?r=(null==t?void 0:t.order_value)||(null==t?void 0:t.gross_amount)||0:"Digital Manager Guru"===o&&(r=parseFloat((null==t?void 0:t.valor_liquido)||(null==t?void 0:t.net_amount)||"0"))}r>0&&o>=1&&o<=12&&(n[o-1].revenue+=r)}catch(e){console.error("Erro ao processar evento:",e)}}),n}catch(e){return console.error("Erro na fun\xe7\xe3o getMonthlyRevenue:",e),Array.from({length:12},(e,a)=>({month:a+1,revenue:0}))}}async function r(e,a,t,n){let r=o.N.from("raw_events").select("\n      id,\n      event_type,\n      payload_json,\n      received_at,\n      import_tag,\n      platforms(name)\n    ");if("webhook"===n?r=r.is("import_tag",null):"imported"===n&&(r=r.not("import_tag","is",null)),a){let e=new Date("".concat(a,"T00:00:00.000-03:00"));r=r.gte("received_at",e.toISOString()),console.log("Filtro in\xedcio: ".concat(a," -> ").concat(e.toISOString()))}if(t){let e=new Date("".concat(t,"T23:59:59.999-03:00"));r=r.lte("received_at",e.toISOString()),console.log("Filtro fim: ".concat(t," -> ").concat(e.toISOString()))}let l=[],i=!0,d=0;for(;i;){let{data:e,error:a}=await r.order("received_at",{ascending:!1}).range(d,d+1e3-1);if(a)return{data:null,error:a};if(e&&e.length>0?(l=[...l,...e],d+=1e3,i=1e3===e.length):i=!1,l.length>2e4){console.warn("Limite de seguran\xe7a atingido: 20.000 registros");break}}let s=l,u=null==s?void 0:s.map(e=>{var a,t,o,n,r,l,i,d,s,u,c,m;return{id:e.id.toString(),platform_order_id:(null==(a=e.payload_json)?void 0:a.order_id)||"N/A",order_date:e.received_at,created_at:e.received_at,status:(()=>{var a,t,o,n;let r=null==(t=e.payload_json)||null==(a=t.order_status)?void 0:a.toLowerCase(),l=null==(n=e.payload_json)||null==(o=n.webhook_event_type)?void 0:o.toLowerCase();return"approved"===r||(null==l?void 0:l.includes("approved"))||"paid"===r||(null==l?void 0:l.includes("paid"))?"paid":"refunded"===r||(null==l?void 0:l.includes("refund"))?"refunded":"canceled"===r||(null==l?void 0:l.includes("cancel"))?"canceled":"chargeback"===r||(null==l?void 0:l.includes("chargeback"))?"chargeback":"pending"})(),original_status:(null==(t=e.payload_json)?void 0:t.order_status)||(null==(o=e.payload_json)?void 0:o.webhook_event_type)||"unknown",csv_status:e.import_tag?"from_csv":"from_webhook",gross_amount:((null==(m=e.payload_json)||null==(c=m.Commissions)?void 0:c.product_base_price)||0)/100,net_amount:(()=>{var a;let t=null==(a=e.payload_json)?void 0:a.Commissions,o=null==t?void 0:t.my_commission,n=null==t?void 0:t.settlement_amount;return(o||n||0)/100})(),currency:(null==(r=e.payload_json)||null==(n=r.Commissions)?void 0:n.currency)||"BRL",customer_name:(()=>{var a,t;let o=null==(t=e.payload_json)||null==(a=t.Customer)?void 0:a.full_name;return o||(e.import_tag?"Cliente Importado":"N/A")})(),customer_email:(()=>{var a,t;let o=null==(t=e.payload_json)||null==(a=t.Customer)?void 0:a.email;return o||(e.import_tag?"imported@email.com":"N/A")})(),product_name:(()=>{var a,t;let o=null==(t=e.payload_json)||null==(a=t.Product)?void 0:a.product_name;return o||(e.import_tag?"Produto Importado":"N/A")})(),product_id:(()=>{var a,t;let o=null==(t=e.payload_json)||null==(a=t.Product)?void 0:a.product_id;return o||(e.import_tag?"imported":"N/A")})(),platform_name:(null==(l=e.platforms)?void 0:l.name)||"Kiwify",webhook_payload:e.payload_json,import_tag:e.import_tag,is_imported:!!e.import_tag,platforms:e.platforms,customers:{name:null==(d=e.payload_json)||null==(i=d.Customer)?void 0:i.full_name,email:null==(u=e.payload_json)||null==(s=u.Customer)?void 0:s.email}}});return{data:(null==u?void 0:u.sort((e,a)=>new Date(a.order_date).getTime()-new Date(e.order_date).getTime()))||[],error:null}}async function l(e){let{error:a}=await o.N.from("raw_events").delete().eq("id",e);return{error:a}}async function i(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,{data:a,error:t}=await o.N.from("raw_events").select("\n      id,\n      event_type,\n      payload_json,\n      received_at,\n      platform_id,\n      platforms(name)\n    ").order("received_at",{ascending:!1}).limit(e);return{data:null==a?void 0:a.map(e=>{var a,t,o,n,r;return{id:e.id.toString(),platform:(null==(t=e.platforms)||null==(a=t[0])?void 0:a.name)||"unknown",event_type:e.event_type||"unknown",order_id:null==(o=e.payload_json)?void 0:o.order_id,customer_email:null==(r=e.payload_json)||null==(n=r.Customer)?void 0:n.email,processed:!0,error_message:null,payload:e.payload_json,created_at:e.received_at}}),error:t}}async function d(){let e=[],a=!0,t=0;for(;a;){let{data:n,error:r}=await o.N.from("raw_events").select("\n        id,\n        payload_json,\n        received_at,\n        platforms(name)\n      ").order("received_at",{ascending:!1}).range(t,t+1e3-1);if(r)return{data:null,error:r};if(n&&n.length>0?(e=[...e,...n],t+=1e3,a=1e3===n.length):a=!1,e.length>2e4){console.warn("Limite de seguran\xe7a atingido: 20.000 registros");break}}let n=e,r=new Map;null==n||n.forEach(e=>{try{var a,t,o,n,l,i,d,s,u,c,m,_;let p=null==(a=e.payload_json)?void 0:a.Customer;if(!p)return;let v=(null==(t=p.cpf)?void 0:t.replace(/[^\d]/g,""))||"",g=(null==(o=p.email)?void 0:o.toLowerCase().trim())||"",f="";if(g&&g.includes("@")?f="email:".concat(g):v&&v.length>=10&&(f="cpf:".concat(v)),!f)return;let w=(null==(l=e.payload_json)||null==(n=l.Product)?void 0:n.product_name)||"",y=new Date(e.received_at),h=p.phone_number||"",D=p.full_name||"",N=(null==(d=e.platforms)||null==(i=d.name)?void 0:i.toLowerCase())||"";if(isNaN(y.getTime()))return;r.has(f)||r.set(f,{name:D,email:g,phone:h,cpf:v||null,dzaDate:null,mentoriaDate:null,materials:[],daysBetween:null});let C=r.get(f);D&&D.length>C.name.length&&(C.name=D),h&&!C.phone&&(C.phone=h),g&&!C.email&&(C.email=g),v&&!C.cpf&&(C.cpf=v);let j=null==(u=e.payload_json)||null==(s=u.order_status)?void 0:s.toLowerCase(),A=null==(m=e.payload_json)||null==(c=m.webhook_event_type)?void 0:c.toLowerCase();("approved"===j||"paid"===j||(null==A?void 0:A.includes("approved"))||(null==A?void 0:A.includes("paid")))&&("kiwify"===N&&(w.toLowerCase().includes("dza")||w.toLowerCase().includes("do zero a auditor fiscal")||w.toLowerCase().includes("treinamento | do zero a auditor fiscal"))&&(!C.dzaDate||y<new Date(C.dzaDate))&&(C.dzaDate=y.toISOString()),"dmg"===N&&(w.toLowerCase().includes("mentoria individual")||w.toLowerCase().includes("mentoria individual (sem material)"))&&(!C.mentoriaDate||y<new Date(C.mentoriaDate))&&(C.mentoriaDate=y.toISOString()),C.materials||(C.materials=[]),C.materials.find(e=>e.name===w&&e.date===y.toISOString())||C.materials.push({name:w,date:y.toISOString(),platform:(null==(_=e.platforms)?void 0:_.name)||"Unknown"}))}catch(e){console.warn("Erro ao processar evento na jornada do cliente:",e)}});let l=Array.from(r.values()).map(e=>{try{if(e.dzaDate&&e.mentoriaDate){let a=new Date(e.dzaDate),t=new Date(e.mentoriaDate);if(!isNaN(a.getTime())&&!isNaN(t.getTime())){let o=Math.abs(t.getTime()-a.getTime());e.daysBetween=Math.ceil(o/864e5)}}return e.materials&&Array.isArray(e.materials)&&e.materials.sort((e,a)=>{try{let t=new Date(e.date).getTime(),o=new Date(a.date).getTime();if(isNaN(t)||isNaN(o))return 0;return t-o}catch(e){return 0}}),e}catch(a){return console.warn("Erro ao processar cliente na jornada:",a),e}});return l.sort((e,a)=>{try{if(e.dzaDate&&!a.dzaDate)return -1;if(!e.dzaDate&&a.dzaDate)return 1;if(e.dzaDate&&a.dzaDate){let t=new Date(e.dzaDate).getTime(),o=new Date(a.dzaDate).getTime();if(!isNaN(t)&&!isNaN(o))return o-t}let t=e.name||"",o=a.name||"";return t.localeCompare(o)}catch(e){return 0}}),{data:l,error:null}}async function s(e){return await o.N.from("goals").upsert(e,{onConflict:"month,year"}).select().single()}async function u(e,a){console.log("=== INICIANDO getAscensions ===",{month:e,year:a});let{data:t,error:o}=await d();if(o||!t)return{data:0,error:o};let n=new Date(a,e-1,1),r=new Date(a,e,0,23,59,59),l=t.filter(e=>{if(!e.dzaDate||!e.mentoriaDate)return!1;let a=new Date(e.mentoriaDate);return a>=n&&a<=r});return console.log("Ascens\xf5es encontradas para ".concat(e,"/").concat(a,":"),l.length),{data:l.length,error:null}}async function c(e,a){console.log("=== INICIANDO getGoalProgress ===",{month:e,year:a});let{data:t,error:n}=await o.N.from("goals").select("*").eq("month",e).eq("year",a).single();if(console.log("Resultado da busca da meta:",{goal:t,goalError:n}),n||!t)return{error:(null==n?void 0:n.message)||"Meta n\xe3o encontrada para este per\xedodo",data:null};let l="".concat(a,"-").concat(e.toString().padStart(2,"0"),"-01"),i="".concat(a,"-").concat(e.toString().padStart(2,"0"),"-").concat(new Date(a,e,0).getDate().toString().padStart(2,"0")),{data:d,error:s}=await r(void 0,l,i);if(s)return{error:s.message,data:null};console.log("Goal Progress - Orders found:",{totalOrders:null==d?void 0:d.length,dateRange:"".concat(l," to ").concat(i),sampleOrder:null==d?void 0:d[0]});let u=(null==d?void 0:d.filter(e=>"paid"===e.status))||[],c=new Set;u.forEach(e=>{c.add(e.platform_name||"Sem plataforma")}),console.log("Plataformas encontradas:",Array.from(c));let m=0,_=0,p=0,v=0,g=0,f=0,w=0,y=0,h=new Map;return u.forEach(e=>{var a,t;let o=(null==(a=e.product_name)?void 0:a.toLowerCase())||"",n=e.net_amount||0,r=(null==(t=e.platform_name)?void 0:t.toLowerCase())||"";g+=n,h.has(r)||h.set(r,{count:0,revenue:0});let l=h.get(r);l.count++,l.revenue+=n,"kiwify"===r&&(m++,p+=n,f++),(o.includes("mentoria")||o.includes("individual"))&&(_++,v+=n,w++),"kiwify"!==r&&y++}),console.log("=== CONTAGEM DETALHADA ==="),console.log("Total de pedidos pagos:",u.length),console.log("Vendas Kiwify (DZA):",f),console.log("Mentoria vendas:",w),console.log("Outras plataformas:",y),console.log("--- BREAKDOWN POR PLATAFORMA ---"),h.forEach((e,a)=>{console.log("".concat(a,": ").concat(e.count," vendas, R$ ").concat(e.revenue.toFixed(2)))}),console.log("--- FATURAMENTO ---"),console.log("DZA Revenue (Kiwify apenas):",p),console.log("Mentoria Revenue (todos produtos mentoria):",v),console.log("Global Revenue (original):",g),console.log("=========================="),console.log("Goal Progress - Final results:",{dzaSales:m,mentoriaSales:_,dzaRevenue:p,mentoriaRevenue:v,globalRevenue:g}),{data:{goal:t,current:{dza_sales:m,mentoria_sales:_,dza_revenue:p,mentoria_revenue:v,global_revenue:g},progress:{dza_sales:t.dza_sales_target>0?m/t.dza_sales_target*100:0,mentoria_sales:t.mentoria_sales_target>0?_/t.mentoria_sales_target*100:0,dza_revenue:t.dza_revenue_target>0?p/t.dza_revenue_target*100:0,mentoria_revenue:t.mentoria_revenue_target>0?v/t.mentoria_revenue_target*100:0,global_revenue:t.global_revenue_target>0?g/t.global_revenue_target*100:0}},error:null}}},4138:(e,a,t)=>{t.d(a,{A:()=>r});var o=t(5931),n={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},r=(e,a)=>{let t=(0,o.forwardRef)((t,r)=>{let{color:l="currentColor",size:i=24,strokeWidth:d=2,absoluteStrokeWidth:s,children:u,...c}=t;return(0,o.createElement)("svg",{ref:r,...n,width:i,height:i,stroke:l,strokeWidth:s?24*Number(d)/Number(i):d,className:"lucide lucide-".concat(e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()),...c},[...a.map(e=>{let[a,t]=e;return(0,o.createElement)(a,t)}),...(Array.isArray(u)?u:[u])||[]])});return t.displayName="".concat(e),t}},9354:(e,a,t)=>{t.d(a,{N:()=>o});let o=(0,t(338).UU)("https://camdhrxwfqkxamdxyviv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhbWRocnh3ZnFreGFtZHh5dml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3Nzk3MTIsImV4cCI6MjA3MjM1NTcxMn0.NtGdZqfHYHUCjAmOrtrxD4a4pb2riyhjAbQ26aGa-n0")}}]);