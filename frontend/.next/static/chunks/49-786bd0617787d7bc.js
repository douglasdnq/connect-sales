"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[49],{1077:(e,a,t)=>{t.d(a,{$c:()=>u,DW:()=>d,JO:()=>l,SX:()=>r,WF:()=>o,hp:()=>s,m0:()=>i});var n=t(9354);async function o(e,a,t){let o=n.N.from("raw_events").select("\n      id,\n      event_type,\n      payload_json,\n      received_at,\n      import_tag,\n      platforms(name)\n    ");if(a){let e=new Date("".concat(a,"T00:00:00.000-03:00"));o=o.gte("received_at",e.toISOString()),console.log("Filtro in\xedcio: ".concat(a," -> ").concat(e.toISOString()))}if(t){let e=new Date("".concat(t,"T23:59:59.999-03:00"));o=o.lte("received_at",e.toISOString()),console.log("Filtro fim: ".concat(t," -> ").concat(e.toISOString()))}let r=[],l=!0,i=0;for(;l;){let{data:e,error:a}=await o.order("received_at",{ascending:!1}).range(i,i+1e3-1);if(a)return{data:null,error:a};if(e&&e.length>0?(r=[...r,...e],i+=1e3,l=1e3===e.length):l=!1,r.length>2e4){console.warn("Limite de seguran\xe7a atingido: 20.000 registros");break}}let s=r,d=null==s?void 0:s.map(e=>{var a,t,n,o,r,l,i,s,d,u,c,m,_,p,g,v,f,w,y,h;return{id:e.id.toString(),platform_order_id:(null==(a=e.payload_json)?void 0:a.order_id)||"N/A",order_date:e.received_at,created_at:e.received_at,status:(()=>{var a,t,n,o;let r=null==(t=e.payload_json)||null==(a=t.order_status)?void 0:a.toLowerCase(),l=null==(o=e.payload_json)||null==(n=o.webhook_event_type)?void 0:n.toLowerCase();return"approved"===r||(null==l?void 0:l.includes("approved"))||"paid"===r||(null==l?void 0:l.includes("paid"))?"paid":"refunded"===r||(null==l?void 0:l.includes("refund"))?"refunded":"canceled"===r||(null==l?void 0:l.includes("cancel"))?"canceled":"chargeback"===r||(null==l?void 0:l.includes("chargeback"))?"chargeback":"pending"})(),original_status:(null==(t=e.payload_json)?void 0:t.order_status)||(null==(n=e.payload_json)?void 0:n.webhook_event_type)||"unknown",csv_status:e.import_tag?"from_csv":"from_webhook",gross_amount:((null==(h=e.payload_json)||null==(y=h.Commissions)?void 0:y.product_base_price)||0)/100,net_amount:(()=>{var a;let t=null==(a=e.payload_json)?void 0:a.Commissions,n=null==t?void 0:t.my_commission,o=null==t?void 0:t.settlement_amount;return(n||o||0)/100})(),currency:(null==(r=e.payload_json)||null==(o=r.Commissions)?void 0:o.currency)||"BRL",customer_name:(null==(i=e.payload_json)||null==(l=i.Customer)?void 0:l.full_name)||"N/A",customer_email:(null==(d=e.payload_json)||null==(s=d.Customer)?void 0:s.email)||"N/A",product_name:(null==(c=e.payload_json)||null==(u=c.Product)?void 0:u.product_name)||"N/A",product_id:(null==(_=e.payload_json)||null==(m=_.Product)?void 0:m.product_id)||"N/A",platform_name:(null==(p=e.platforms)?void 0:p.name)||"Kiwify",webhook_payload:e.payload_json,import_tag:e.import_tag,is_imported:!!e.import_tag,platforms:e.platforms,customers:{name:null==(v=e.payload_json)||null==(g=v.Customer)?void 0:g.full_name,email:null==(w=e.payload_json)||null==(f=w.Customer)?void 0:f.email}}});return{data:(null==d?void 0:d.sort((e,a)=>new Date(a.order_date).getTime()-new Date(e.order_date).getTime()))||[],error:null}}async function r(e){let{error:a}=await n.N.from("raw_events").delete().eq("id",e);return{error:a}}async function l(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,{data:a,error:t}=await n.N.from("raw_events").select("\n      id,\n      event_type,\n      payload_json,\n      received_at,\n      platform_id,\n      platforms(name)\n    ").order("received_at",{ascending:!1}).limit(e);return{data:null==a?void 0:a.map(e=>{var a,t,n,o,r;return{id:e.id.toString(),platform:(null==(t=e.platforms)||null==(a=t[0])?void 0:a.name)||"unknown",event_type:e.event_type||"unknown",order_id:null==(n=e.payload_json)?void 0:n.order_id,customer_email:null==(r=e.payload_json)||null==(o=r.Customer)?void 0:o.email,processed:!0,error_message:null,payload:e.payload_json,created_at:e.received_at}}),error:t}}async function i(){let e=[],a=!0,t=0;for(;a;){let{data:o,error:r}=await n.N.from("raw_events").select("\n        id,\n        payload_json,\n        received_at,\n        platforms(name)\n      ").order("received_at",{ascending:!1}).range(t,t+1e3-1);if(r)return{data:null,error:r};if(o&&o.length>0?(e=[...e,...o],t+=1e3,a=1e3===o.length):a=!1,e.length>2e4){console.warn("Limite de seguran\xe7a atingido: 20.000 registros");break}}let o=e,r=new Map;null==o||o.forEach(e=>{try{var a,t,n,o,l,i,s,d,u,c,m,_;let p=null==(a=e.payload_json)?void 0:a.Customer;if(!p)return;let g=(null==(t=p.cpf)?void 0:t.replace(/[^\d]/g,""))||"",v=(null==(n=p.email)?void 0:n.toLowerCase().trim())||"",f="";if(v&&v.includes("@")?f="email:".concat(v):g&&g.length>=10&&(f="cpf:".concat(g)),!f)return;let w=(null==(l=e.payload_json)||null==(o=l.Product)?void 0:o.product_name)||"",y=new Date(e.received_at),h=p.phone_number||"",D=p.full_name||"",N=(null==(s=e.platforms)||null==(i=s.name)?void 0:i.toLowerCase())||"";if(isNaN(y.getTime()))return;r.has(f)||r.set(f,{name:D,email:v,phone:h,cpf:g||null,dzaDate:null,mentoriaDate:null,materials:[],daysBetween:null});let C=r.get(f);D&&D.length>C.name.length&&(C.name=D),h&&!C.phone&&(C.phone=h),v&&!C.email&&(C.email=v),g&&!C.cpf&&(C.cpf=g);let j=null==(u=e.payload_json)||null==(d=u.order_status)?void 0:d.toLowerCase(),A=null==(m=e.payload_json)||null==(c=m.webhook_event_type)?void 0:c.toLowerCase();("approved"===j||"paid"===j||(null==A?void 0:A.includes("approved"))||(null==A?void 0:A.includes("paid")))&&("kiwify"===N&&(w.toLowerCase().includes("dza")||w.toLowerCase().includes("do zero a auditor fiscal")||w.toLowerCase().includes("treinamento | do zero a auditor fiscal"))&&(!C.dzaDate||y<new Date(C.dzaDate))&&(C.dzaDate=y.toISOString()),"dmg"===N&&(w.toLowerCase().includes("mentoria individual")||w.toLowerCase().includes("mentoria individual (sem material)"))&&(!C.mentoriaDate||y<new Date(C.mentoriaDate))&&(C.mentoriaDate=y.toISOString()),C.materials||(C.materials=[]),C.materials.find(e=>e.name===w&&e.date===y.toISOString())||C.materials.push({name:w,date:y.toISOString(),platform:(null==(_=e.platforms)?void 0:_.name)||"Unknown"}))}catch(e){console.warn("Erro ao processar evento na jornada do cliente:",e)}});let l=Array.from(r.values()).map(e=>{try{if(e.dzaDate&&e.mentoriaDate){let a=new Date(e.dzaDate),t=new Date(e.mentoriaDate);if(!isNaN(a.getTime())&&!isNaN(t.getTime())){let n=Math.abs(t.getTime()-a.getTime());e.daysBetween=Math.ceil(n/864e5)}}return e.materials&&Array.isArray(e.materials)&&e.materials.sort((e,a)=>{try{let t=new Date(e.date).getTime(),n=new Date(a.date).getTime();if(isNaN(t)||isNaN(n))return 0;return t-n}catch(e){return 0}}),e}catch(a){return console.warn("Erro ao processar cliente na jornada:",a),e}});return l.sort((e,a)=>{try{if(e.dzaDate&&!a.dzaDate)return -1;if(!e.dzaDate&&a.dzaDate)return 1;if(e.dzaDate&&a.dzaDate){let t=new Date(e.dzaDate).getTime(),n=new Date(a.dzaDate).getTime();if(!isNaN(t)&&!isNaN(n))return n-t}let t=e.name||"",n=a.name||"";return t.localeCompare(n)}catch(e){return 0}}),{data:l,error:null}}async function s(e){return await n.N.from("goals").upsert(e,{onConflict:"month,year"}).select().single()}async function d(e,a){console.log("=== INICIANDO getAscensions ===",{month:e,year:a});let{data:t,error:n}=await i();if(n||!t)return{data:0,error:n};let o=new Date(a,e-1,1),r=new Date(a,e,0,23,59,59),l=t.filter(e=>{if(!e.dzaDate||!e.mentoriaDate)return!1;let a=new Date(e.mentoriaDate);return a>=o&&a<=r});return console.log("Ascens\xf5es encontradas para ".concat(e,"/").concat(a,":"),l.length),{data:l.length,error:null}}async function u(e,a){console.log("=== INICIANDO getGoalProgress ===",{month:e,year:a});let{data:t,error:r}=await n.N.from("goals").select("*").eq("month",e).eq("year",a).single();if(console.log("Resultado da busca da meta:",{goal:t,goalError:r}),r||!t)return{error:(null==r?void 0:r.message)||"Meta n\xe3o encontrada para este per\xedodo",data:null};let l="".concat(a,"-").concat(e.toString().padStart(2,"0"),"-01"),i="".concat(a,"-").concat(e.toString().padStart(2,"0"),"-").concat(new Date(a,e,0).getDate().toString().padStart(2,"0")),{data:s,error:d}=await o(void 0,l,i);if(d)return{error:d.message,data:null};console.log("Goal Progress - Orders found:",{totalOrders:null==s?void 0:s.length,dateRange:"".concat(l," to ").concat(i),sampleOrder:null==s?void 0:s[0]});let u=(null==s?void 0:s.filter(e=>"paid"===e.status))||[],c=new Set;u.forEach(e=>{c.add(e.platform_name||"Sem plataforma")}),console.log("Plataformas encontradas:",Array.from(c));let m=0,_=0,p=0,g=0,v=0,f=0,w=0,y=0,h=new Map;return u.forEach(e=>{var a,t;let n=(null==(a=e.product_name)?void 0:a.toLowerCase())||"",o=e.net_amount||0,r=(null==(t=e.platform_name)?void 0:t.toLowerCase())||"";v+=o,h.has(r)||h.set(r,{count:0,revenue:0});let l=h.get(r);l.count++,l.revenue+=o,"kiwify"===r&&(m++,p+=o,f++),(n.includes("mentoria")||n.includes("individual"))&&(_++,g+=o,w++),"kiwify"!==r&&y++}),console.log("=== CONTAGEM DETALHADA ==="),console.log("Total de pedidos pagos:",u.length),console.log("Vendas Kiwify (DZA):",f),console.log("Mentoria vendas:",w),console.log("Outras plataformas:",y),console.log("--- BREAKDOWN POR PLATAFORMA ---"),h.forEach((e,a)=>{console.log("".concat(a,": ").concat(e.count," vendas, R$ ").concat(e.revenue.toFixed(2)))}),console.log("--- FATURAMENTO ---"),console.log("DZA Revenue (Kiwify apenas):",p),console.log("Mentoria Revenue (todos produtos mentoria):",g),console.log("Global Revenue (original):",v),console.log("=========================="),console.log("Goal Progress - Final results:",{dzaSales:m,mentoriaSales:_,dzaRevenue:p,mentoriaRevenue:g,globalRevenue:v}),{data:{goal:t,current:{dza_sales:m,mentoria_sales:_,dza_revenue:p,mentoria_revenue:g,global_revenue:v},progress:{dza_sales:t.dza_sales_target>0?m/t.dza_sales_target*100:0,mentoria_sales:t.mentoria_sales_target>0?_/t.mentoria_sales_target*100:0,dza_revenue:t.dza_revenue_target>0?p/t.dza_revenue_target*100:0,mentoria_revenue:t.mentoria_revenue_target>0?g/t.mentoria_revenue_target*100:0,global_revenue:t.global_revenue_target>0?v/t.global_revenue_target*100:0}},error:null}}},4138:(e,a,t)=>{t.d(a,{A:()=>r});var n=t(5931),o={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},r=(e,a)=>{let t=(0,n.forwardRef)((t,r)=>{let{color:l="currentColor",size:i=24,strokeWidth:s=2,absoluteStrokeWidth:d,children:u,...c}=t;return(0,n.createElement)("svg",{ref:r,...o,width:i,height:i,stroke:l,strokeWidth:d?24*Number(s)/Number(i):s,className:"lucide lucide-".concat(e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()),...c},[...a.map(e=>{let[a,t]=e;return(0,n.createElement)(a,t)}),...(Array.isArray(u)?u:[u])||[]])});return t.displayName="".concat(e),t}},9354:(e,a,t)=>{t.d(a,{N:()=>n});let n=(0,t(338).UU)("https://camdhrxwfqkxamdxyviv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhbWRocnh3ZnFreGFtZHh5dml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3Nzk3MTIsImV4cCI6MjA3MjM1NTcxMn0.NtGdZqfHYHUCjAmOrtrxD4a4pb2riyhjAbQ26aGa-n0")}}]);