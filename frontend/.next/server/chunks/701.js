"use strict";exports.id=701,exports.ids=[701],exports.modules={21701:(a,b,c)=>{c.d(b,{$c:()=>k,DW:()=>j,JO:()=>g,SX:()=>f,WF:()=>e,hp:()=>i,m0:()=>h});var d=c(59422);async function e(a,b,c,e){let f=d.N.from("raw_events").select(`
      id,
      event_type,
      payload_json,
      received_at,
      import_tag,
      platforms(name)
    `);if("webhook"===e?f=f.is("import_tag",null):"imported"===e&&(f=f.not("import_tag","is",null)),b){let a=new Date(`${b}T00:00:00.000-03:00`);f=f.gte("received_at",a.toISOString()),console.log(`Filtro in\xedcio: ${b} -> ${a.toISOString()}`)}if(c){let a=new Date(`${c}T23:59:59.999-03:00`);f=f.lte("received_at",a.toISOString()),console.log(`Filtro fim: ${c} -> ${a.toISOString()}`)}let g=[],h=!0,i=0;for(;h;){let{data:a,error:b}=await f.order("received_at",{ascending:!1}).range(i,i+1e3-1);if(b)return{data:null,error:b};if(a&&a.length>0?(g=[...g,...a],i+=1e3,h=1e3===a.length):h=!1,g.length>2e4){console.warn("Limite de seguran\xe7a atingido: 20.000 registros");break}}let j=g,k=j?.map(a=>({id:a.id.toString(),platform_order_id:a.payload_json?.order_id||"N/A",order_date:a.received_at,created_at:a.received_at,status:(()=>{let b=a.payload_json?.order_status?.toLowerCase(),c=a.payload_json?.webhook_event_type?.toLowerCase();return"approved"===b||c?.includes("approved")||"paid"===b||c?.includes("paid")?"paid":"refunded"===b||c?.includes("refund")?"refunded":"canceled"===b||c?.includes("cancel")?"canceled":"chargeback"===b||c?.includes("chargeback")?"chargeback":"pending"})(),original_status:a.payload_json?.order_status||a.payload_json?.webhook_event_type||"unknown",csv_status:a.import_tag?"from_csv":"from_webhook",gross_amount:(a.payload_json?.Commissions?.product_base_price||0)/100,net_amount:(()=>{let b=a.payload_json?.Commissions,c=b?.my_commission,d=b?.settlement_amount;return(c||d||0)/100})(),currency:a.payload_json?.Commissions?.currency||"BRL",customer_name:(()=>{let b=a.payload_json?.Customer?.full_name;return b||(a.import_tag?"Cliente Importado":"N/A")})(),customer_email:(()=>{let b=a.payload_json?.Customer?.email;return b||(a.import_tag?"imported@email.com":"N/A")})(),product_name:(()=>{let b=a.payload_json?.Product?.product_name;return b||(a.import_tag?"Produto Importado":"N/A")})(),product_id:(()=>{let b=a.payload_json?.Product?.product_id;return b||(a.import_tag?"imported":"N/A")})(),platform_name:a.platforms?.name||"Kiwify",webhook_payload:a.payload_json,import_tag:a.import_tag,is_imported:!!a.import_tag,platforms:a.platforms,customers:{name:a.payload_json?.Customer?.full_name,email:a.payload_json?.Customer?.email}}));return{data:k?.sort((a,b)=>new Date(b.order_date).getTime()-new Date(a.order_date).getTime())||[],error:null}}async function f(a){let{error:b}=await d.N.from("raw_events").delete().eq("id",a);return{error:b}}async function g(a=100){let{data:b,error:c}=await d.N.from("raw_events").select(`
      id,
      event_type,
      payload_json,
      received_at,
      platform_id,
      platforms(name)
    `).order("received_at",{ascending:!1}).limit(a);return{data:b?.map(a=>({id:a.id.toString(),platform:a.platforms?.[0]?.name||"unknown",event_type:a.event_type||"unknown",order_id:a.payload_json?.order_id,customer_email:a.payload_json?.Customer?.email,processed:!0,error_message:null,payload:a.payload_json,created_at:a.received_at})),error:c}}async function h(){let a=[],b=!0,c=0;for(;b;){let{data:e,error:f}=await d.N.from("raw_events").select(`
        id,
        payload_json,
        received_at,
        platforms(name)
      `).order("received_at",{ascending:!1}).range(c,c+1e3-1);if(f)return{data:null,error:f};if(e&&e.length>0?(a=[...a,...e],c+=1e3,b=1e3===e.length):b=!1,a.length>2e4){console.warn("Limite de seguran\xe7a atingido: 20.000 registros");break}}let e=a,f=new Map;e?.forEach(a=>{try{let b=a.payload_json?.Customer;if(!b)return;let c=b.cpf?.replace(/[^\d]/g,"")||"",d=b.email?.toLowerCase().trim()||"",e="";if(d&&d.includes("@")?e=`email:${d}`:c&&c.length>=10&&(e=`cpf:${c}`),!e)return;let g=a.payload_json?.Product?.product_name||"",h=new Date(a.received_at),i=b.phone_number||"",j=b.full_name||"",k=a.platforms?.name?.toLowerCase()||"";if(isNaN(h.getTime()))return;f.has(e)||f.set(e,{name:j,email:d,phone:i,cpf:c||null,dzaDate:null,mentoriaDate:null,materials:[],daysBetween:null});let l=f.get(e);j&&j.length>l.name.length&&(l.name=j),i&&!l.phone&&(l.phone=i),d&&!l.email&&(l.email=d),c&&!l.cpf&&(l.cpf=c);let m=a.payload_json?.order_status?.toLowerCase(),n=a.payload_json?.webhook_event_type?.toLowerCase();("approved"===m||"paid"===m||n?.includes("approved")||n?.includes("paid"))&&("kiwify"===k&&(g.toLowerCase().includes("dza")||g.toLowerCase().includes("do zero a auditor fiscal")||g.toLowerCase().includes("treinamento | do zero a auditor fiscal"))&&(!l.dzaDate||h<new Date(l.dzaDate))&&(l.dzaDate=h.toISOString()),"dmg"===k&&(g.toLowerCase().includes("mentoria individual")||g.toLowerCase().includes("mentoria individual (sem material)"))&&(!l.mentoriaDate||h<new Date(l.mentoriaDate))&&(l.mentoriaDate=h.toISOString()),l.materials||(l.materials=[]),l.materials.find(a=>a.name===g&&a.date===h.toISOString())||l.materials.push({name:g,date:h.toISOString(),platform:a.platforms?.name||"Unknown"}))}catch(a){console.warn("Erro ao processar evento na jornada do cliente:",a)}});let g=Array.from(f.values()).map(a=>{try{if(a.dzaDate&&a.mentoriaDate){let b=new Date(a.dzaDate),c=new Date(a.mentoriaDate);if(!isNaN(b.getTime())&&!isNaN(c.getTime())){let d=Math.abs(c.getTime()-b.getTime());a.daysBetween=Math.ceil(d/864e5)}}return a.materials&&Array.isArray(a.materials)&&a.materials.sort((a,b)=>{try{let c=new Date(a.date).getTime(),d=new Date(b.date).getTime();if(isNaN(c)||isNaN(d))return 0;return c-d}catch(a){return 0}}),a}catch(b){return console.warn("Erro ao processar cliente na jornada:",b),a}});return g.sort((a,b)=>{try{if(a.dzaDate&&!b.dzaDate)return -1;if(!a.dzaDate&&b.dzaDate)return 1;if(a.dzaDate&&b.dzaDate){let c=new Date(a.dzaDate).getTime(),d=new Date(b.dzaDate).getTime();if(!isNaN(c)&&!isNaN(d))return d-c}let c=a.name||"",d=b.name||"";return c.localeCompare(d)}catch(a){return 0}}),{data:g,error:null}}async function i(a){return await d.N.from("goals").upsert(a,{onConflict:"month,year"}).select().single()}async function j(a,b){console.log("=== INICIANDO getAscensions ===",{month:a,year:b});let{data:c,error:d}=await h();if(d||!c)return{data:0,error:d};let e=new Date(b,a-1,1),f=new Date(b,a,0,23,59,59),g=c.filter(a=>{if(!a.dzaDate||!a.mentoriaDate)return!1;let b=new Date(a.mentoriaDate);return b>=e&&b<=f});return console.log(`Ascens\xf5es encontradas para ${a}/${b}:`,g.length),{data:g.length,error:null}}async function k(a,b){console.log("=== INICIANDO getGoalProgress ===",{month:a,year:b});let{data:c,error:f}=await d.N.from("goals").select("*").eq("month",a).eq("year",b).single();if(console.log("Resultado da busca da meta:",{goal:c,goalError:f}),f||!c)return{error:f?.message||"Meta n\xe3o encontrada para este per\xedodo",data:null};let g=`${b}-${a.toString().padStart(2,"0")}-01`,h=`${b}-${a.toString().padStart(2,"0")}-${new Date(b,a,0).getDate().toString().padStart(2,"0")}`,{data:i,error:j}=await e(void 0,g,h);if(j)return{error:j.message,data:null};console.log("Goal Progress - Orders found:",{totalOrders:i?.length,dateRange:`${g} to ${h}`,sampleOrder:i?.[0]});let k=i?.filter(a=>"paid"===a.status)||[],l=new Set;k.forEach(a=>{l.add(a.platform_name||"Sem plataforma")}),console.log("Plataformas encontradas:",Array.from(l));let m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=new Map;return k.forEach(a=>{let b=a.product_name?.toLowerCase()||"",c=a.net_amount||0,d=a.platform_name?.toLowerCase()||"";q+=c,u.has(d)||u.set(d,{count:0,revenue:0});let e=u.get(d);e.count++,e.revenue+=c,"kiwify"===d&&(m++,o+=c,r++),(b.includes("mentoria")||b.includes("individual"))&&(n++,p+=c,s++),"kiwify"!==d&&t++}),console.log("=== CONTAGEM DETALHADA ==="),console.log("Total de pedidos pagos:",k.length),console.log("Vendas Kiwify (DZA):",r),console.log("Mentoria vendas:",s),console.log("Outras plataformas:",t),console.log("--- BREAKDOWN POR PLATAFORMA ---"),u.forEach((a,b)=>{console.log(`${b}: ${a.count} vendas, R$ ${a.revenue.toFixed(2)}`)}),console.log("--- FATURAMENTO ---"),console.log("DZA Revenue (Kiwify apenas):",o),console.log("Mentoria Revenue (todos produtos mentoria):",p),console.log("Global Revenue (original):",q),console.log("=========================="),console.log("Goal Progress - Final results:",{dzaSales:m,mentoriaSales:n,dzaRevenue:o,mentoriaRevenue:p,globalRevenue:q}),{data:{goal:c,current:{dza_sales:m,mentoria_sales:n,dza_revenue:o,mentoria_revenue:p,global_revenue:q},progress:{dza_sales:c.dza_sales_target>0?m/c.dza_sales_target*100:0,mentoria_sales:c.mentoria_sales_target>0?n/c.mentoria_sales_target*100:0,dza_revenue:c.dza_revenue_target>0?o/c.dza_revenue_target*100:0,mentoria_revenue:c.mentoria_revenue_target>0?p/c.mentoria_revenue_target*100:0,global_revenue:c.global_revenue_target>0?q/c.global_revenue_target*100:0}},error:null}}}};